<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>äº”æ„Ÿã§å­¦ã¹ã‚‹è‹±èªå­¦ç¿’</title>
    <link rel="stylesheet" href="All-project.css"> <!-- CSSã‚’ã¾ã¨ã‚ã¦èª­ã¿è¾¼ã¿ -->
</head>
<body>
    <div id="header" style="position: fixed; top: 0; left: 0; padding: 10px; z-index: 1000;">
  <img src="homeIcon.png" alt="Home" id="homeIcon" style="width: 85px; cursor: pointer;">
</div>
    <!-- Step 1: Toioã¨ã¤ãªã’ã‚‹ -->
    <div id="step1" class="step">
        <h1>Step1 Toioã¨ã¤ãªã’ã‚‹</h1>
        <div class="button-container">
            <button id="connectButton" class="button start-button">ã¤ãªã’ã‚‹</button>
            <button id="goToStep2" class="button next-button" disabled style="display: none;">æ¬¡ã¸</button>
        </div>
        <div id="robotLog"></div>
    </div>


<!-- Step 2: è¨€èªã‚’é¸ã¶ -->
<div id="step2" class="step" style="display: none;">
    <h1>Step 2: è¨€èªã‚’é¸ã‚“ã§ã­</h1>
    <div class="language-container">
        <button class="language-button" data-language="en">
            <img src="https://flagcdn.com/w40/us.png" alt="English" class="flag-icon">
            <span>English</span>
        </button>

        <!-- ğŸ‡ªğŸ‡¸ Spanish -->
        <button class="language-button" data-language="es">
            <img src="https://flagcdn.com/w40/es.png" alt="EspaÃ±ol" class="flag-icon">
            <span>EspaÃ±ol</span>
            </button>

          <!-- ğŸ‡«ğŸ‡· French -->
        <button class="language-button" data-language="fr">
            <img src="https://flagcdn.com/w40/fr.png" alt="FranÃ§ais" class="flag-icon">
            <span>FranÃ§ais</span>
        </button>
    </div>
    <button id="goToStep3" class="button next-button" disabled style="display: none;">æ¬¡ã¸</button>

</div>


<!-- Step 3: ã‚³ãƒ¼ã‚¹ã‚’é¸ã¶ -->
<div id="step3" class="step" style="display: none;">
    <h1>Step 3: ã‚³ãƒ¼ã‚¹ã‚’é¸ã‚“ã§ã­</h1>
    <div class="button-container">
        <button class="course-button navigation" data-course="navigation">é“æ¡ˆå†…ã‚³ãƒ¼ã‚¹</button>
        <button class="course-button pronunciation" data-course="pronunciation">ç™ºéŸ³ã‚³ãƒ¼ã‚¹</button>
        <button class="course-button verbsAdverbs" data-course="verbsAdverbs">å‹•ä½œã¨è¡¨ç¾</button>
    </div>
    <button id="goToStep4" class="button next-button" disabled style="display: none;">æ¬¡ã¸</button>
</div>


<!-- Step 4: ãƒ¬ãƒ™ãƒ«ã‚’é¸ã¶ -->
<div id="step4-navigation" class="step" style="display: none;">
  <h1>Step4 ãƒ¬ãƒ™ãƒ«ã‚’é¸ã‚“ã§ã­</h1>
  <div class="button-container">

    <div class="level-option">
      <button class="level-button easy" data-level="beginner">ã‹ã‚“ãŸã‚“</button>
      <div class="example-snippet" data-for="beginner"></div>
    </div>

    <div class="level-option">
      <button class="level-button normal" data-level="intermediate">ãµã¤ã†</button>
      <div class="example-snippet" data-for="intermediate"></div>
    </div>

    <div class="level-option">
      <button class="level-button hard" data-level="advanced">ã‚€ãšã‹ã—ã„</button>
      <div class="example-snippet" data-for="advanced"></div>
    </div>

  </div>

  <button id="goToStep5" class="button next-button" disabled style="display: none;">æ¬¡ã¸</button>

  <div id="levelExamples" class="level-example-container"></div>
</div>


<!--å‰¯è©ï¼šå‹•ä½œã¨è¡¨ç¾ã‚’å­¦ã¶ãƒšãƒ¼ã‚¸-->
<div id="step4-verbsAdverbs" class="step" style="display: none;">
    <h1>Step 4: å‹•ä½œã¨è¡¨ç¾ã‚’å­¦ã¼ã†ï¼</h1>
    <h2 class="B">ä½¿ãˆã‚‹è¡¨ç¾</h2>
    <div id="expressionContainer-verbsAdverbs" class="grid-container"></div>
    <!-- âœ… ãƒã‚¤ã‚¯èµ·å‹•ãƒœã‚¿ãƒ³ã‚’è¿½åŠ  -->
     <div class="nav-button-group">
    <button onclick="startNavigationListening()" class="btn navcheck-btn">ğŸ™ Start</button>
    <button onclick="stopNavigationListening()" class="btn stop-btn">â¹ Stop</button>
    </div>
</div>

<!-- ç™ºéŸ³ç·´ç¿’ã‚³ãƒ¼ã‚¹ -->
<div id="step4-pronunciation" class="step" style="display: none;">
  <h1 class="step-title">Step 4: ç™ºéŸ³ã‚’ç·´ç¿’ã—ã‚ˆã†ï¼</h1>
  <p class="step-subtext">ä»¥ä¸‹ã®å˜èªã‚’å£°ã«å‡ºã—ã¦ç·´ç¿’ã—ã¦ã¿ã‚ˆã†ï¼</p>

  <div class="practice-container">
    <input type="text" id="practiceInput" placeholder="ã“ã“ã«å˜èªã‚„æ–‡ã‚’å…¥åŠ›" class="practice-input">

    <div class="button-group">
      <button onclick="speak()" class="btn speak-btn">ğŸ”ˆ èª­ã¿ä¸Šã’</button>
      <button onclick="startRecognition()" class="btn check-btn">ğŸ™ ç™ºéŸ³ãƒã‚§ãƒƒã‚¯</button>

      <!-- ã‚«ã‚¹ã‚¿ãƒ ã‚»ãƒ¬ã‚¯ãƒˆ -->
      <div class="custom-select" id="customSelect">
        <div class="selected" id="selectedOption">
          <div data-value="en-US"><img src="https://flagcdn.com/w40/us.png" width="20"> American English</div>
        </div>
        <div class="options" id="optionsList" style="display: none;">
          <div data-value="en-GB"><img src="https://flagcdn.com/w40/gb.png" width="20"> British English</div> 
          <div data-value="en-AU"><img src="https://flagcdn.com/w40/au.png" width="20"> Australian English</div>
          <div data-value="en-IN"><img src="https://flagcdn.com/w40/in.png" width="20"> Indian English</div>
          <div data-value="en-CA"><img src="https://flagcdn.com/w40/ca.png" width="20"> Canadian English</div>
        </div>
      </div>

      <input type="hidden" id="voiceSelect" value="en-GB">
    </div>

    <!-- âœ… ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯è¡¨ç¤º -->
    <div id="feedback" class="feedback-box"></div>
  </div>
</div>




    <!-- Step 5: éŸ³å£°èªè­˜ã§Toioã‚’åˆ¶å¾¡(é“æ¡ˆå†…ã‚³ãƒ¼ã‚¹å°‚ç”¨) -->
    <div id="step5" class="step" style="display: none;">
        <h1>Step5 å‹•ã‹ã—ã¦ã¿ã‚ˆã†ï¼</h1>
        <h2 class="B">ä½¿ãˆã‚‹è¡¨ç¾</h2>
        <div id="expressionContainer" class="grid-container"></div>

        <!-- âœ… ãƒã‚¤ã‚¯èµ·å‹•ãƒœã‚¿ãƒ³ã‚’è¿½åŠ  -->
    <!-- âœ… ãƒã‚¤ã‚¯èµ·å‹•ãƒœã‚¿ãƒ³ã«ã‚¯ãƒ©ã‚¹ã‚’è¿½åŠ  -->
    <div class="nav-button-group">
  <button onclick="startNavigationListening()" class="btn navcheck-btn">ğŸ™ Start</button>
  <button onclick="stopNavigationListening()" class="btn stop-btn">â¹ Stop</button>
  </div>

    </div>





<!-- ğŸ™ï¸ ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ³¢å½¢ 
<div id="waveCanvasContainer" style="display: none;">
  <canvas id="waveCanvas" width="600" height="100"></canvas>
</div> -->




     <!-- âœ… æˆ»ã‚‹ãƒœã‚¿ãƒ³ï¼ˆå…¨ã‚¹ãƒ†ãƒƒãƒ—å…±é€šï¼‰ -->
     <div id="navigationButtons" class="navigation-buttons">
        <button id="backButton" class="button back-button" style="display: none;">â¬…ï¸ æˆ»ã‚‹</button>

     <!-- ğŸ™ï¸ éŸ³å£°èªè­˜ãƒ­ã‚° -->
<table id="logTable" class="log-table" style="display: none;">
  <thead>
    <tr>
      <th>æ­£ç¢ºæ€§</th>
      <th>ğŸ¤ èã“ãˆãŸè¨€è‘‰</th>
    </tr>
  </thead>
  <tbody id="logBody">
    <!-- JavaScriptã§ãƒ­ã‚°ãŒã“ã“ã«è¿½åŠ ã•ã‚Œã¾ã™ -->
  </tbody>
</table>

<div class="command-section"></div>


    

    
    
   
    <script>
        let selectedCourse = null;
        let toio = null;
        let toioCharacteristic = null;
        let waveformStarted = false;
        let animationId = null;
        let scrollX = 0;
        let voices = [];
        let currentCourse = null;
        let soundCharacteristic = null;
        let recognition = null;
        let recognitionPronunciation = null;
        let recognitionNavigation = null;
        let shouldRestartNavigation = false;
        // âœ… Toio UUIDs ã‚°ãƒ­ãƒ¼ãƒãƒ«ã«å®šç¾©ã™ã‚‹
          const TOIO_SERVICE_UUID = '10b20100-5b3b-4571-9508-cf3efcd7bbae';
          const MOTOR_CHARACTERISTIC_UUID = '10b20102-5b3b-4571-9508-cf3efcd7bbae';
          const SOUND_CHARACTERISTIC_UUID = '10b20104-5b3b-4571-9508-cf3efcd7bbae';



// âœ… æ­£è§£ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ï¼šç·‘ + æˆåŠŸéŸ³
async function flashToioGreen(duration = 2000) {
  showFeedback("âœ… æ­£ã—ãç™ºéŸ³ã§ãã¾ã—ãŸï¼", true);

  if (!ledCharacteristic) {
    console.warn("âš ï¸ Toioã®LEDã«æ¥ç¶šã•ã‚Œã¦ã„ã¾ã›ã‚“ï¼ˆãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã¯ç”»é¢è¡¨ç¤ºã®ã¿ï¼‰");
    return;
  }

  const data = new Uint8Array([
    0x03, Math.round(duration / 10), 0x01, 0x01,
    0x00, 0xFF, 0x00 // ç·‘
  ]);
  await ledCharacteristic.writeValue(data);

  if (soundCharacteristic) {
    const effectMatIn = new Uint8Array([0x02, 0x04, 0xFF]); // æˆåŠŸéŸ³
    await soundCharacteristic.writeValue(effectMatIn);
    console.log("âœ… æˆåŠŸéŸ³ã‚’å†ç”Ÿã—ã¾ã—ãŸ");
  }
}

// âŒ ä¸æ­£è§£ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ï¼šèµ¤ + ã‚¨ãƒ©ãƒ¼éŸ³
async function flashToioRed(duration = 2000) {
  showFeedback("âŒ ç™ºéŸ³ãŒé•ã„ã¾ã—ãŸã€‚ã‚‚ã†ä¸€åº¦ãƒˆãƒ©ã‚¤ï¼", false);

  if (!ledCharacteristic) {
    console.warn("âš ï¸ Toioã®LEDã«æ¥ç¶šã•ã‚Œã¦ã„ã¾ã›ã‚“ï¼ˆãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã¯ç”»é¢è¡¨ç¤ºã®ã¿ï¼‰");
    return;
  }

  const data = new Uint8Array([
    0x03, Math.round(duration / 10), 0x01, 0x01,
    0xFF, 0x00, 0x00 // èµ¤
  ]);
  await ledCharacteristic.writeValue(data);

  if (soundCharacteristic) {
    const errorSound = new Uint8Array([0x02, 0x02, 0xFF]); // ã‚¨ãƒ©ãƒ¼éŸ³
    await soundCharacteristic.writeValue(errorSound);
    console.log("âŒ ã‚¨ãƒ©ãƒ¼éŸ³ã‚’å†ç”Ÿã—ã¾ã—ãŸ");
  }
}

// â“ å¾®å¦™ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ï¼šé»„è‰² + è»½ã‚ã®éŸ³
async function flashToioYellow(duration = 2000) {
  showFeedback("â“ å¾®å¦™ãªç™ºéŸ³ã§ã—ãŸã€‚æƒœã—ã„ï¼", false);

  if (!ledCharacteristic) {
    console.warn("âš ï¸ Toioã®LEDã«æ¥ç¶šã•ã‚Œã¦ã„ã¾ã›ã‚“ï¼ˆãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã¯ç”»é¢è¡¨ç¤ºã®ã¿ï¼‰");
    return;
  }

  const data = new Uint8Array([
    0x03, Math.round(duration / 10), 0x01, 0x01,
    0xFF, 0xFF, 0x00 // é»„è‰²
  ]);
  await ledCharacteristic.writeValue(data);

  if (soundCharacteristic) {
    const neutralSound = new Uint8Array([0x02, 0x01, 0xFF]); // è»½ã„éŸ³
    await soundCharacteristic.writeValue(neutralSound);
    console.log("â“ å¾®å¦™ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯éŸ³ã‚’å†ç”Ÿã—ã¾ã—ãŸ");
  }
}


// âœ… === ã“ã“ã‹ã‚‰ã‚«ã‚¹ã‚¿ãƒ ã‚»ãƒ¬ã‚¯ãƒˆé–¢é€£ã‚’è¿½è¨˜ï¼ ===
  const customSelect = document.getElementById("customSelect");
  const selected = document.getElementById("selectedOption");
  const options = document.getElementById("optionsList");
  const hiddenInput = document.getElementById("voiceSelect");

  selected.addEventListener("click", () => {
    options.style.display = options.style.display === "none" ? "block" : "none";
  });

  options.querySelectorAll("div").forEach(option => {
    option.addEventListener("click", () => {
      selected.innerHTML = option.innerHTML;
      hiddenInput.value = option.dataset.value;
      options.style.display = "none";
    });
  });

  document.addEventListener("click", (e) => {
    if (!customSelect.contains(e.target)) {
      options.style.display = "none";
    }
  });

  function showFeedback(message, isSuccess = true) {
    const feedback = document.getElementById("feedback");
    feedback.textContent = message;
    feedback.className = "feedback-box " + (isSuccess ? "feedback-success" : "feedback-error");
    feedback.style.display = "block";
    setTimeout(() => feedback.style.display = "none", 3000);
  }



// ğŸŒ ç™ºéŸ³ç·´ç¿’ç”¨ã®éŸ³å£°èªè­˜ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆï¼ˆToioç”¨ã¨æ··ã–ã‚‰ãªã„ã‚ˆã†ã«åˆ†é›¢ï¼‰
function initRecognitionPronunciation() {
  if (!recognitionPronunciation) {
    recognitionPronunciation = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
    recognitionPronunciation.lang = 'en-US';         // è‹±èªï¼ˆã‚¢ãƒ¡ãƒªã‚«ï¼‰
    recognitionPronunciation.interimResults = false; // ç¢ºå®šçµæœã®ã¿
    recognitionPronunciation.maxAlternatives = 1;    // å€™è£œ1ã¤ã§OK
    console.log("ğŸ¤ éŸ³å£°èªè­˜ã‚’åˆæœŸåŒ–ã—ã¾ã—ãŸ");
  }
}
// ğŸ”ˆ éŸ³å£°åˆæˆï¼ˆTTSï¼‰ã«ä½¿ã†å£°ã®ä¸€è¦§ã‚’å–å¾—
window.speechSynthesis.onvoiceschanged = () => {
  voices = speechSynthesis.getVoices();
  console.log("ğŸ“¢ åˆ©ç”¨å¯èƒ½ãªéŸ³å£°ãƒªã‚¹ãƒˆï¼š");
  voices.forEach(v => console.log(`${v.name} (${v.lang})`));
};

// âœ… éŸ³å£°åˆæˆï¼ˆTTSï¼‰ã§èª­ã¿ä¸Šã’ã‚‹é–¢æ•°
function speak() {
  const text = document.getElementById("practiceInput")?.value;
  const lang = document.getElementById("voiceSelect")?.value;

  if (!text || !lang) return;

  const sentences = text.match(/[^.!?]+[.!?]+/g) || [text];

  function speakSentences(index = 0) {
    if (index >= sentences.length) return;

    const utterance = new SpeechSynthesisUtterance(sentences[index].trim());
    utterance.lang = lang;
    utterance.rate = 1.1;

    // âœ… lang ã«ä¸€è‡´ã™ã‚‹ voice ã‚’ã‚ˆã‚Šå³å¯†ã«é¸ã¶
    const matchingVoices = voices.filter(v => v.lang === lang);
    
    // å„ªå…ˆåº¦ï¼šGoogleç³» > langä¸€è‡´ã®ã¿
    const preferredVoice = matchingVoices.find(v => v.name.toLowerCase().includes("google")) || matchingVoices[0];
    
    if (preferredVoice) utterance.voice = preferredVoice;

    utterance.onend = () => speakSentences(index + 1);
    speechSynthesis.speak(utterance);
  }

  speechSynthesis.cancel(); // å‰ã®ç™ºè©±ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«
  speakSentences();
}


// âœ… åŠ¹æœéŸ³ã‚’é³´ã‚‰ã™ãŸã‚ã®ãƒ‡ãƒ¼ã‚¿ï¼ˆMat in ã®åŠ¹æœéŸ³ ID: 0x04ï¼‰
const effectMatIn = new Uint8Array([0x02, 0x04, 0xFF]);

// âœ… Toio ã«åŠ¹æœéŸ³å†ç”Ÿã‚³ãƒãƒ³ãƒ‰ã‚’é€ã‚‹
function playToioEffect() {
  if (!soundCharacteristic) {
    console.warn("ğŸ”‡ ã‚µã‚¦ãƒ³ãƒ‰Characteristicæœªæ¥ç¶š");
    return;
  }
  soundCharacteristic.writeValue(effectMatIn)
    .then(() => console.log("ğŸ”Š ToioåŠ¹æœéŸ³é€ä¿¡æˆåŠŸ"))
    .catch(e => console.error("âš ï¸ åŠ¹æœéŸ³é€ä¿¡å¤±æ•—", e));
}

// âœ… ç™ºéŸ³ãƒã‚§ãƒƒã‚¯æ©Ÿèƒ½ï¼ˆéŸ³å£°èªè­˜ï¼‹Toioåå¿œã¤ãï¼‰
// âœ… ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯è¡¨ç¤ºé–¢æ•°
function showFeedback(message, color = "green") {
  const box = document.getElementById("feedback");
  if (!box) return;
  box.textContent = message;
  box.style.color = color;
  setTimeout(() => {
    box.textContent = "";
  }, 2000);
}


// âœ… å…¥åŠ›ã¨èªè­˜çµæœã‚’æ­£è¦åŒ–ï¼ˆnormalizeï¼‰ã™ã‚‹é–¢æ•°
function normalizeText(text) {
  return text
    .toLowerCase() // å°æ–‡å­—åŒ–
    .replace(/[.,!?'"â€œâ€â€˜â€™]/g, "") // å¥èª­ç‚¹ãƒ»è¨˜å·ã‚’å‰Šé™¤
    .replace(/\s+/g, " ") // è¤‡æ•°ã‚¹ãƒšãƒ¼ã‚¹ã‚’1ã¤ã«
    .trim(); // å‰å¾Œã®ã‚¹ãƒšãƒ¼ã‚¹ã‚’é™¤å»
}

// âœ… ç™ºéŸ³ãƒã‚§ãƒƒã‚¯æ©Ÿèƒ½ï¼ˆéŸ³å£°èªè­˜ï¼‹Toioåå¿œã¤ãï¼‰
function startRecognition() {
  initRecognitionPronunciation();

  const targetRaw = document.getElementById('practiceInput').value;
  const target = normalizeText(targetRaw);
  if (!target) return alert("ğŸ¯ ç™ºéŸ³ã—ãŸã„å˜èªã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");

  recognitionPronunciation.onresult = (event) => {
    const spokenRaw = event.results[0][0].transcript;
    const spoken = normalizeText(spokenRaw);
    console.log("ğŸ¤ èªè­˜çµæœ:", spoken);

    if (spoken === target || spoken.includes(target)) {
      showFeedback("âœ… æ­£ã—ãç™ºéŸ³ã§ãã¾ã—ãŸï¼", "green");
      flashToioGreen(); // âœ… ã“ã‚Œã ã‘ã§è‰²ï¼‹éŸ³OKï¼
    } else {
      showFeedback(`âŒ ã€Œ${spokenRaw}ã€ã¨èã“ãˆã¾ã—ãŸã€‚ã‚‚ã†ä¸€åº¦ãƒˆãƒ©ã‚¤ï¼`, "red");
      flashToioRed();   // âŒ èµ¤ï¼‹ã‚¨ãƒ©ãƒ¼éŸ³ï¼ˆã‚‚ã—è¿½åŠ ã—ã¦ã„ã‚Œã°ï¼‰
    }
  };

  recognitionPronunciation.onerror = (event) => {
    alert("âš ï¸ éŸ³å£°èªè­˜ã‚¨ãƒ©ãƒ¼: " + event.error);
  };

  try {
    if (recognitionPronunciation.running) {
      recognitionPronunciation.stop();
      recognitionPronunciation.onend = () => {
        recognitionPronunciation.start();
        console.log("ğŸ¤ èªè­˜å†ã‚¹ã‚¿ãƒ¼ãƒˆï¼ˆonendï¼‰");
      };
    } else {
      recognitionPronunciation.start();
      console.log("ğŸ¤ èªè­˜ã‚¹ã‚¿ãƒ¼ãƒˆï¼ˆåˆå›ï¼‰");
    }
  } catch (e) {
    console.error("âŒ startRecognition å¤±æ•—:", e);
  }
}
//æˆåŠŸã¨å¤±æ•—ã®å¢ƒç›® NormalizeText()ã§è¨±å¯ã•ã‚Œã‚‹ç¯„å›²ã¨ã¯
//Hello?	hello	hello vs hello	âœ… æˆåŠŸæ‰±ã„








//HTMLã®èª­ã¿è¾¼ã¿ãŒå®Œäº†ã—ãŸã‚‰ä¸­ã®ã‚³ãƒ¼ãƒ‰ã‚’å®Ÿè¡Œã—ã¦ã­ï¼ã¨ã„ã†æ„å‘³ã§ã‚ã‚‹ã€‚
  document.addEventListener('DOMContentLoaded', () => {
    console.log("ğŸŒ DOMContentLoaded fired!");

        
          
// âœ… ã‚¹ãƒ†ãƒƒãƒ—ç®¡ç†ã€€stepIndexã‹ã‚‰ stepIdã«å¤‰æ›´ã—ãŸï¼ï¼ 
// currentStepIdã¯ãªã—ã€‚
const steps = document.querySelectorAll('.step');
const backButton = document.getElementById('backButton');
let currentStep = 0;

function showStep(stepId) {
 steps.forEach(step => {
  step.style.display = (step.id === stepId) ? 'block' : 'none';
});

const currentStepElement = document.getElementById(stepId);
if (!currentStepElement) {
  console.warn(`âŒ æŒ‡å®šã•ã‚ŒãŸ stepId "${stepId}" ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“`);
  return;
}

const currentStepIndex = [...steps].findIndex(step => step.id === stepId);
currentStep = currentStepIndex;

currentStepId = stepId;

console.log(`ğŸš€ ç¾åœ¨ã®ã‚¹ãƒ†ãƒƒãƒ—: ${stepId}`);

// Step4ã«å…¥ã£ãŸæ™‚ã®å‡¦ç†
  if (stepId === 'step4-pronunciation') {
    const input = document.getElementById('practiceInput');
    if (input) input.value = '';               // å…¥åŠ›æ¬„ã‚’ãƒªã‚»ãƒƒãƒˆ
    speechSynthesis.cancel();                  // TTSãŒå†ç”Ÿä¸­ãªã‚‰æ­¢ã‚ã‚‹
  }


  // âœ… æˆ»ã‚‹ãƒœã‚¿ãƒ³ã®è¡¨ç¤ºåˆ¶å¾¡
 if (backButton) {
  backButton.style.display = currentStepIndex <= 0 ? 'none' : 'inline-block';
}

const logTable = document.getElementById('logTable');
if (logTable) {
  const shouldShowLog =
    stepId === 'step5' ||
    stepId === 'step4-verbsAdverbs';

  logTable.style.display = shouldShowLog ? 'table' : 'none';
}
}



  // âœ… waveCanvas ã®è¡¨ç¤ºåˆ¶å¾¡ & æ³¢å½¢æç”»å‡¦ç†ã®èµ·å‹•
  /*const waveCanvasContainer = document.getElementById('waveCanvasContainer');
  if (waveCanvasContainer) {
  if (stepId === 'step4-verbsAdverbs' || stepId === 'step5') {
    waveCanvasContainer.style.display = 'block';
    // âŒ startWaveform() ã¯å‘¼ã°ãªã„ï¼
  } else {
    waveCanvasContainer.style.display = 'none';
    stopWaveform();
    waveformStarted = false;
  }
} */


// showStepé–¢æ•°ã®ä¸‹ã«è¿½è¨˜ï¼
document.getElementById("homeIcon").addEventListener("click", () => {
  showStep('step1');

  // Step1ç‰¹æœ‰ã®åˆæœŸåŒ–å‡¦ç†ï¼ˆä»»æ„ï¼‰
  document.getElementById("goToStep2").disabled = true;
  document.getElementById("goToStep2").style.display = "none";
});

/*
function stopWaveform() {

  if (animationId) {
    cancelAnimationFrame(animationId);
    animationId = null;
    console.log("ğŸ›‘ æ³¢å½¢æç”»ã‚’åœæ­¢ã—ã¾ã—ãŸ");
  }
}



ã€€ async function startWaveform() {
  console.log("ğŸ¬ startWaveform() å‘¼ã³å‡ºã•ã‚ŒãŸï¼");

  try {
    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
    console.log("ğŸ™ï¸ ãƒã‚¤ã‚¯å–å¾—æˆåŠŸï¼");

    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    const analyser = audioCtx.createAnalyser();
    const source = audioCtx.createMediaStreamSource(stream);
    source.connect(analyser);
    analyser.fftSize = 512;

    const bufferLength = analyser.fftSize;
    const dataArray = new Uint8Array(bufferLength);
    const canvas = document.getElementById('waveCanvas');
    const ctx = canvas.getContext('2d');

    if (!ctx) {
      console.warn("âš ï¸ waveCanvas ã® context ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸï¼");
      return;
    }

    ctx.lineWidth = 2.5;
    ctx.strokeStyle = '#f39c12';

   function drawBars() {
  animationId = requestAnimationFrame(drawBars);
  analyser.getByteFrequencyData(dataArray); // éŸ³é‡ã®å‘¨æ³¢æ•°ã‚¹ãƒšã‚¯ãƒˆãƒ«

  ctx.clearRect(0, 0, canvas.width, canvas.height); // å‰ã®æ³¢ã‚’æ¶ˆã™

  const barWidth = 4;
  const gap = 2;
  const barCount = Math.floor(canvas.width / (barWidth + gap));

  for (let i = 0; i < barCount; i++) {
    const barHeight = dataArray[i] / 255 * canvas.height;
    ctx.fillStyle = `hsl(${i / barCount * 120}, 80%, 60%)`;
    ctx.fillRect(i * (barWidth + gap), canvas.height - barHeight, barWidth, barHeight);
  }
}


    drawBars();
  } catch (err) {
    console.error("âŒ ãƒã‚¤ã‚¯å–å¾—ã«å¤±æ•—:", err);
  }
}
*/




let recognitionInitialized = false;

window.startNavigationListening = function () {
  console.log("ğŸš€ startNavigationListening å‘¼ã³å‡ºã•ã‚ŒãŸï¼");
  console.log("ğŸ” recognitionNavigation =", recognitionNavigation);

  if (!recognitionInitialized) {
    recognitionNavigation = initRecognitionNavigation();
    if (!recognitionNavigation) {
      alert("âš ï¸ éŸ³å£°èªè­˜ãŒã¾ã æº–å‚™ã§ãã¦ã„ã¾ã›ã‚“ï¼ˆèªè­˜ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒ nullï¼‰");
      return;
    }

    recognitionNavigation.onerror = (event) => {
      const error = event.error;
      if (error === "no-speech" || error === "aborted") return;

      let friendlyMessage = `âš ï¸ ã‚¨ãƒ©ãƒ¼: ${error}`;
      if (error === "audio-capture") {
        friendlyMessage = "ğŸ™ï¸ ãƒã‚¤ã‚¯ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚";
      } else if (error === "not-allowed" || error === "service-not-allowed") {
        friendlyMessage = "ğŸš« ãƒã‚¤ã‚¯ã®ä½¿ç”¨ãŒãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã¦ã„ã¾ã™ã€‚";
      }
      logRecognition(friendlyMessage);
      console.error("Recognition error:", error);
    };

    recognitionNavigation.onend = () => {
      console.log("ğŸ›‘ éŸ³å£°èªè­˜çµ‚äº†ï¼ˆå†ã‚¹ã‚¿ãƒ¼ãƒˆã—ã¾ã›ã‚“ï¼‰");
    };

    recognitionInitialized = true;
  }

  try {
    recognitionNavigation.start();
    console.log("ğŸ§­ ãƒŠãƒ“éŸ³å£°èªè­˜ã‚¹ã‚¿ãƒ¼ãƒˆï¼");
    startWaveform(); //æ³¢å½¢æç”»ã‚‚ã“ã“ã§é–‹å§‹ã™ã‚‹ï¼
  } catch (e) {
    console.error("âŒ éŸ³å£°èªè­˜ã‚¹ã‚¿ãƒ¼ãƒˆã«å¤±æ•—:", e);
  }
};

window.stopNavigationListening = function () {
  if (!recognitionNavigation) {
    console.warn("ğŸ›‘ stopNavigationListening å‘¼ã³å‡ºã•ã‚ŒãŸãŒã€åˆæœŸåŒ–ã•ã‚Œã¦ã„ã¾ã›ã‚“");
    return;
  }

  recognitionNavigation.stop();
  console.log("ğŸ›‘ ãƒŠãƒ“éŸ³å£°èªè­˜ã‚¹ãƒˆãƒƒãƒ—ï¼");
  stopWaveform(); //æ³¢å½¢ã‚‚Stop
};



// âœ… LEDåˆ¶å¾¡ç”¨UUIDï¼ˆè‰²ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ï¼šç·‘ãƒ»èµ¤ãƒ»é»„ãªã©ã‚’å…‰ã‚‰ã›ã‚‹ï¼‰
// âœ… LEDåˆ¶å¾¡ç”¨ã®UUIDï¼ˆToioã‚’å…‰ã‚‰ã›ã‚‹ãŸã‚ã«å¿…è¦ï¼ï¼‰
const LED_CHARACTERISTIC_UUID = "10b20103-5b3b-4571-9508-cf3efcd7bbae"; // ğŸ”° ã“ã‚Œã‚’ã‚°ãƒ­ãƒ¼ãƒãƒ«å®šç¾©ã—ã¦ãŠã„ã¦ï¼


// toioã‚’ã¤ãªã’ã‚‹
async function connectToio() {
  const robotLog = document.getElementById('robotLog');

  if (toio) {
    console.warn("âš ï¸ ã™ã§ã«Toioã«æ¥ç¶šæ¸ˆã¿ã§ã™");
    robotLog.insertAdjacentHTML('afterbegin', 'ğŸ”„ ã™ã§ã«æ¥ç¶šæ¸ˆã¿ã§ã™<br>');
    showStep("step2"); // âœ… ã™ã§ã«æ¥ç¶šæ¸ˆã¿ã§ã‚‚Step2ã¸é€²ã‚€
    return;
  }

  try {
    const device = await navigator.bluetooth.requestDevice({
      filters: [{ services: [TOIO_SERVICE_UUID] }]
    });

    robotLog.insertAdjacentHTML('afterbegin', 'ã‚µãƒ¼ãƒãƒ¼ã«æ¥ç¶šã—ã¦ã„ã¾ã™...<br>');

    const server = await device.gatt.connect();
    const service = await server.getPrimaryService(TOIO_SERVICE_UUID);

    // âœ… ãƒ¢ãƒ¼ã‚¿ãƒ¼åˆ¶å¾¡
    toioCharacteristic = await service.getCharacteristic(MOTOR_CHARACTERISTIC_UUID);
    toio = toioCharacteristic;

    // âœ… ã‚µã‚¦ãƒ³ãƒ‰åˆ¶å¾¡
    soundCharacteristic = await service.getCharacteristic(SOUND_CHARACTERISTIC_UUID);
    console.log("ğŸ”Š Sound characteristic æ¥ç¶šå®Œäº†");

    // âœ… LEDåˆ¶å¾¡
    ledCharacteristic = await service.getCharacteristic(LED_CHARACTERISTIC_UUID);
    console.log("ğŸ’¡ LED characteristic æ¥ç¶šå®Œäº†");

    robotLog.insertAdjacentHTML('afterbegin', 'âœ… æ¥ç¶šã«æˆåŠŸã—ã¾ã—ãŸ!<br>');

    document.getElementById('connectButton').disabled = true;
    document.getElementById('goToStep2').disabled = false;

    device.addEventListener('gattserverdisconnected', () => {
      robotLog.insertAdjacentHTML('afterbegin', 'âš ï¸ ToioãŒåˆ‡æ–­ã•ã‚Œã¾ã—ãŸ<br>');
      toioCharacteristic = null;
      soundCharacteristic = null;
      ledCharacteristic = null;
      toio = null;
    });

  } catch (error) {
    robotLog.insertAdjacentHTML('afterbegin', `âŒ æ¥ç¶šã‚¨ãƒ©ãƒ¼: ${error.message}<br>`);
    console.error('Toioæ¥ç¶šã‚¨ãƒ©ãƒ¼:', error);

    document.getElementById('connectButton').disabled = false;
    document.getElementById('goToStep2').disabled = true;

    toio = null;
    toioCharacteristic = null;
    soundCharacteristic = null;
    ledCharacteristic = null;
  }

  // âœ… æˆåŠŸãƒ»å¤±æ•—ã«ã‹ã‹ã‚ã‚‰ãš Step2 ã«é€²ã‚€
  showStep("step2");
}





       // âœ… ãƒ¬ãƒ™ãƒ«é¸æŠã¨è¡¨ç¾æ›´æ–°
// âœ… ãƒ¬ãƒ™ãƒ«é¸æŠã¨è¡¨ç¾æ›´æ–°ï¼ˆè‹±èªã®ã¿ï¼‰
const EXPRESSIONS = {
    en: {
        beginner: ['go', 'back', 'right', 'left', 'stop'],
        intermediate: [
            'go straight',
            'turn right',
            'turn left',
            'go back',
            'stop',
            'move and turn right',
            'move and turn left'
        ],
        advanced: [
            'hurry up and go straight',
            'move forward without hesitation',
            'keep going straight',
            'head towards the north',
            'take it easy and go straight',
            'go forward at a slow pace',
            'turn to your right',
            'turn to your left',
            'take a step back',
            'go straight and turn right',
            'go straight and turn left',
            'turn left and go straight',
            'turn right and go straight'
        ]
    }
};

const VERB_ADVERB_LIST = {
    en: [
        'move gently',
        'move slowly',
        'progress slowly',
        'move forward slowly',
        'move fast',
        'run quickly',
        'walk slowly',
        'turn around quickly'
    ]
};

// âœ… container ã‚’å®šç¾©ï¼ˆHTMLå†…ã®idã¨ä¸€è‡´ã•ã›ã‚‹ï¼‰
const container = document.getElementById("expressionContainer-verbsAdverbs");
VERB_ADVERB_LIST.en.forEach(expression => {
    const button = document.createElement("button");
    button.innerText = expression;
    button.classList.add("expression-btn");
    button.addEventListener("click", () => {
        sendCommand("verbsAdverbs", expression);
    });
    container.appendChild(button);
});

 




  //æ¶ˆã™ã‹ã‚‚ã—ã‚Œãªã„
  async function executeCommand(command, toio, language = "en", level = "beginner") {
    console.log("executeCommand CALLED");
    console.log("Command:", command);
    console.log("Language:", language, "| Level:", level);

    const handler = window.toioCommandHandlers?.[command];
    console.log("Handler:", typeof handler === "function" ? "Exists ã€‡" : "None Ã—");

    const commandSet = window.getToioCommand?.(language, level);
    const commandBinary = commandSet?.[command];

    if (!toio || typeof toio.writeValue !== 'function') {
        console.error("Toio is not connected or invalid.");
        return;
    }

    if (typeof handler === "function") {
        try {
            console.log("Executing handler...");
            await handler(toio);
        } catch (err) {
            console.error(`Error executing handler for '${command}':`, err);
        }
        return;
    }

    if (commandBinary instanceof Uint8Array) {
        try {
            console.log("Sending binary command...");
            await toio.writeValue(commandBinary);
        } catch (err) {
            console.error(`Failed to send command '${command}':`, err);
        }
    } else {
        console.warn(`Command '${command}' is not defined.`);
    }
}


/* async:éåŒæœŸé–¢æ•°ã«ã™ã‚‹ã“ã¨ã§ã€å¾Œã« awaitãŒä½¿ç”¨å¯èƒ½ã€‚
typeof å¤‰æ•°ã‚„å€¤ã®ãƒ‡ãƒ¼ã‚¿å‹ã‚’æ–‡å­—åˆ—ã§å¤‰æ›ã™ã‚‹ã€‚ typeof 123 = "number", typeof "Hello = "string" if (typeof handler === "function") handlerãŒé–¢æ•°ãªã‚‰å®Ÿè¡Œã—ã¦ã„ã„ï¼*/

//å„ãƒ¬ãƒ™ãƒ«ãƒœã‚¿ãƒ³ã®ä¸‹ã«ã€Œè‹±èªï¼‹æ—¥æœ¬èªã€ã®ä¾‹ã‚’è¡¨ç¤ºã™ã‚‹é–¢æ•°
function insertLevelSnippets() {
  const levelLabel = {
    beginner: 'ã‹ã‚“ãŸã‚“',
    intermediate: 'ãµã¤ã†',
    advanced: 'ã‚€ãšã‹ã—ã„'
  };

  // beginner, intermediate, advanced ãã‚Œãã‚Œã®ä¾‹æ–‡ã‚’è¡¨ç¤º
  ['beginner', 'intermediate', 'advanced'].forEach(level => {
    const examples = EXPRESSIONS["en"][level].slice(0, 1); // âœ¨ è¡¨ç¤ºã™ã‚‹ä¾‹ã¯1ã¤ã ã‘
    const snippetText = examples.map(e => {
      const jp = TRANSLATIONS[e] || '';
      return `${e}ï¼ˆ${jp}ï¼‰`;
    }).join(', ');

    const container = document.querySelector(`.example-snippet[data-for="${level}"]`);
    if (container) {
      container.innerHTML = `<span class="snippet-label">ä¾‹:</span> ${snippetText}`;
    }
  });
} 

insertLevelSnippets();






        
// âœ… åˆæœŸè¨­å®šï¼ˆè‹±èªå›ºå®šï¼‰
let selectedLanguage = "en";
let selectedLevel = localStorage.getItem('selectedLevel') || 'beginner';
let currentToioCommand = window.getToioCommand(selectedLanguage, selectedLevel);
let lastStep4Id = null;

console.log(`ğŸŒ åˆæœŸè¨€èª: ${selectedLanguage}, ğŸš€ åˆæœŸToioã‚³ãƒãƒ³ãƒ‰:`, currentToioCommand);









// âœ… è‹±èªãƒœã‚¿ãƒ³ã®å‡¦ç†ï¼ˆsetLanguageã¯ä¸è¦ã€‚å¿…è¦å‡¦ç†ã¯ã“ã“ã§å…¨éƒ¨ï¼‰
document.querySelector('.language-button[data-language="en"]').addEventListener("click", function () {
    // âœ… ã‚¹ã‚¿ã‚¤ãƒ«æ›´æ–°
    this.classList.add("selected");

    // âœ… è¨€èªã¨ãƒ¬ãƒ™ãƒ«ã‚’ä¿å­˜
    localStorage.setItem("selectedLanguage", "en");
    selectedLanguage = "en";

    // âœ… Toioã‚³ãƒãƒ³ãƒ‰æ›´æ–°ï¼ˆLevelã‚‚æ—¢ã«é¸ã°ã‚Œã¦ã„ã‚Œã°ï¼‰
    currentToioCommand = window.getToioCommand(selectedLanguage, selectedLevel);

    // âœ… éŸ³å£°èªè­˜ã®è¨€èªã‚‚æ›´æ–°ï¼ˆnavigationç”¨ï¼‰
    if (recognitionNavigation) {
        recognitionNavigation.lang = "en-US";
        console.log("ğŸ—£ï¸ éŸ³å£°èªè­˜ã®è¨€èªã‚’ en-US ã«è¨­å®šã—ã¾ã—ãŸ");
    } else {
        console.log("â³ NavigationéŸ³å£°èªè­˜ã¯ã¾ã åˆæœŸåŒ–ã•ã‚Œã¦ã„ã¾ã›ã‚“");
        // å¿…è¦ã§ã‚ã‚Œã°ã“ã“ã§å†åˆæœŸåŒ–ã‚‚å¯
    }

    // âœ… Step3ï¼ˆã‚³ãƒ¼ã‚¹é¸æŠï¼‰ã¸è‡ªå‹•ç§»å‹•
    showStep("step3");

    // âœ… LevelãŒã™ã§ã«æ±ºã¾ã£ã¦ã„ã‚Œã°ã€ãã®å†…å®¹ã‚‚æ›´æ–°
    if (selectedLevel) {
        updateExpressions("en", selectedLevel);
        showLevelExamples(selectedLevel);
    }
});

// âœ… Step3ã®ã€Œæ¬¡ã¸ã€ãƒœã‚¿ãƒ³ã¯ã‚‚ã†ä½¿ã‚ãªã„ã®ã§å‰Šé™¤ï¼ˆå®Œå…¨è‡ªå‹•åŒ–ã®ãŸã‚ï¼‰
// document.getElementById("goToStep3").addEventListener("click", () => {
//     showStep("step3");
// });


// âœ… Toio ã«ã‚³ãƒãƒ³ãƒ‰ã‚’é€ã‚‹é–¢æ•°ï¼ˆã“ã®ã¾ã¾ã§OKï¼‰
async function moveToio(command) {
    if (!toioCharacteristic) {
        console.warn("âš ï¸ Toio ãŒã¾ã æ¥ç¶šã•ã‚Œã¦ã„ã¾ã›ã‚“ï¼");
        return;
    }

    if (!command) {
        console.warn("âš ï¸ é€ä¿¡ã™ã‚‹ã‚³ãƒãƒ³ãƒ‰ãŒæœªå®šç¾©ã§ã™ï¼");
        return;
    }

    if (!(command instanceof Uint8Array)) {
        console.warn("âš ï¸ æ¸¡ã•ã‚ŒãŸã‚³ãƒãƒ³ãƒ‰ãŒ Uint8Array ã§ã¯ã‚ã‚Šã¾ã›ã‚“ï¼");
        return;
    }

    try {
        await toioCharacteristic.writeValue(command);
        console.log(`ğŸš€ Toio ã«ã‚³ãƒãƒ³ãƒ‰ã‚’é€ä¿¡:`, command);
    } catch (error) {
        console.error("âŒ ã‚³ãƒãƒ³ãƒ‰é€ä¿¡ã‚¨ãƒ©ãƒ¼ï¼ˆToio ãŒåˆ‡æ–­ã•ã‚Œã¦ã„ã‚‹å¯èƒ½æ€§ã‚‚ï¼‰:", error);
    }
}



//ã‚³ãƒ¼ã‚¹ã«ã‚ˆã£ã¦éŸ³å£°èªè­˜ã®æ–¹æ³•ã‚’å¤‰æ›´ã—ã¦ã„ã‚‹ã€‚
document.querySelectorAll('.course-button').forEach(button => {
  button.addEventListener('click', () => {
    selectedCourse = button.dataset.course;
    console.log("âœ… é¸ã‚“ã ã‚³ãƒ¼ã‚¹:", selectedCourse);

    // ğŸ”· ãƒœã‚¿ãƒ³ã®ãƒã‚¤ãƒ©ã‚¤ãƒˆ
    document.querySelectorAll('.course-button').forEach(btn => btn.classList.remove('selected'));
    button.classList.add('selected');

    // ğŸ§¹ å¿µã®ãŸã‚ã€ã™ã¹ã¦ã® recognition ã‚’åœæ­¢
    try { recognitionNavigation.abort(); } catch (e) {}
    try { recognitionPronunciation.abort(); } catch (e) {}

    // âœ… ã‚³ãƒ¼ã‚¹åˆ¥ã«èªè­˜ã‚¨ãƒ³ã‚¸ãƒ³èµ·å‹•ï¼†Step4ã¸åˆ†å²
    if (selectedCourse === "navigation") {
      lastStep4Id = 'step4-navigation';
      showStep("step4-navigation");
      setupNavigationLevels();

      // âœ… éŸ³å£°èªè­˜ã¯ã‚¹ã‚¿ãƒ¼ãƒˆã—ãªã„ï¼ãƒœã‚¿ãƒ³ã§ã‚¹ã‚¿ãƒ¼ãƒˆã™ã‚‹
      const startButton = document.getElementById("startNavigationButton");
      if (startButton) startButton.style.display = "inline-block";

      console.log("ğŸš— é“æ¡ˆå†…ã‚³ãƒ¼ã‚¹ã®ãƒ¬ãƒ™ãƒ«é¸æŠç”»é¢ã¸");

    } else if (selectedCourse === "pronunciation") {
      lastStep4Id = 'step4-pronunciation';
      showStep("step4-pronunciation");

      console.log("ğŸ—£ï¸ ç™ºéŸ³ã‚³ãƒ¼ã‚¹ã¸");

    } else if (selectedCourse === "verbsAdverbs") {
      lastStep4Id = 'step4-verbsAdverbs';
      showStep("step4-verbsAdverbs");
      updateExpressionsVerbsAdverbs();
      console.log("ğŸ­ å‹•ä½œã¨è¡¨ç¾ã‚³ãƒ¼ã‚¹ Step4ã¸");

    } else {
      console.warn("âš ï¸ ã‚³ãƒ¼ã‚¹ãŒæœªé¸æŠã‹ã€å®šç¾©ã•ã‚Œã¦ã„ãªã„ã‚‚ã®ã§ã™ï¼");
    }
  });
});





document.getElementById("backButton").addEventListener("click", () => {
  const currentStepId = Array.from(steps).find(step => step.style.display !== 'none')?.id;

  if (currentStepId === "step2") {
    showStep("step1");
    console.log("â¬…ï¸ Step2ã‹ã‚‰ Step1 ã¸æˆ»ã£ãŸ");
    return;
  }

  if (currentStepId === "step3") {
    showStep("step2");
    console.log("â¬…ï¸ Step3ã‹ã‚‰ Step2 ã¸æˆ»ã£ãŸ");
    return;
  }

  // Step4 â†’ Step3ï¼ˆå…±é€šå‡¦ç†ï¼‰
  if (
    currentStepId === "step4-navigation" ||
    currentStepId === "step4-pronunciation" ||
    currentStepId === "step4-verbsAdverbs"
  ) {
    resetLog();
    showStep("step3");
    console.log(`â¬…ï¸ ${currentStepId} ã‹ã‚‰ Step3ï¼ˆã‚³ãƒ¼ã‚¹é¸æŠï¼‰ã¸æˆ»ã£ãŸ`);
    return;
  }

  // Step5 â†’ å„ã‚³ãƒ¼ã‚¹ã® Step4 ã«æˆ»ã‚‹ï¼ˆlastStep4Id ã‚’ä½¿ã†ï¼‰
  if (currentStepId === "step5") {
    if (lastStep4Id) {
      const targetStep = document.getElementById(lastStep4Id);
      if (targetStep) {
        showStep(lastStep4Id);
        resetLog();
        console.log(`â¬…ï¸ Step5ã‹ã‚‰ ${lastStep4Id} ã«æˆ»ã£ãŸ`);
      } else {
        console.warn("âš ï¸ lastStep4Id ãŒä¸æ­£ã§ã™");
        showStep("step3");
      }
    } else {
      console.warn("âš ï¸ Step5ã‹ã‚‰æˆ»ã‚‹å…ˆãŒæœªè¨­å®šã§ã™");
      showStep("step3");
    }
    return;
  }

  // ãã®ä»– â†’ Step1 ã«æˆ»ã‚‹
  showStep("step1");
  console.log("â¬…ï¸ ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ Step1ï¼ˆè¨€èªé¸æŠï¼‰ã¸æˆ»ã£ãŸ");
});









// ========================
// âœ… é“æ¡ˆå†…ã‚³ãƒ¼ã‚¹ã®ãƒ¬ãƒ™ãƒ«æº–å‚™ï¼ˆä»®ç½®ãï¼‰
// ========================
function setupNavigationLevels() {
    console.log("âœ… ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ç”¨ãƒ¬ãƒ™ãƒ«ã‚»ãƒƒãƒˆã‚’æº–å‚™ä¸­...");
    // â†’ ã“ã“ã«ã‹ã‚“ãŸã‚“ï¼ãµã¤ã†ï¼ã‚€ãšã‹ã—ã„ãƒœã‚¿ãƒ³ã‚’å‡ºã™å‡¦ç†ã‚’æ›¸ã
}


// â­ï¸ ã“ã®ç›´å¾Œã«è¿½åŠ ã§OKï¼ â­ï¸
function updateExpressionsVerbsAdverbs() {
    const expressionContainer = document.getElementById('expressionContainer-verbsAdverbs');
    expressionContainer.innerHTML = '';

    const expressions = [
      "move gently",
       "move slowly", 
       "move fast",
       "progress slowly",
       "move forward slowly",
       "run quickly",
       "walk slowly",
       "turn around quickly",
      ]; // ä»®ã®å‰¯è©è¡¨ç¾ãƒªã‚¹ãƒˆ

    expressions.forEach(expression => {
        const div = document.createElement('div');
        div.className = 'card';
        div.innerHTML = `<div class="expression-en">${expression}</div>`;
        expressionContainer.appendChild(div);
    });
}


/*
document.querySelectorAllã¨ã¯
ã¾ãšdocument: ãƒ–ãƒ©ã‚¦ã‚¶ã«è¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹ã‚¦ã‚§ãƒ–ãƒšãƒ¼ã‚¸å…¨ä½“
querySelectAll('â—‹â—‹') ãã®ä¸­ã‹ã‚‰ã€æ¡ä»¶ã«åˆã†ã‚‚ã®ã‚’å…¨éƒ¨æ¢ã—ã¦ãƒªã‚¹ãƒˆã«ã™ã‚‹ã€‚
ãã‚Œã‚’ forEachã§ï¼‘ã¤ï¼‘ã¤ã«ä½•ã‚’ã™ã‚‹ã‹ã‚’è¿½åŠ ã§ãã‚‹ã€‚
*/

function updateExpressions(selectedLanguage, selectedLevel) {
    const expressionContainer = document.getElementById('expressionContainer');
    const expressionBalloon = document.getElementById('expressionBalloon');
    const expressionText = document.getElementById('expressionText');

    // ã‚³ãƒ³ãƒ†ãƒŠã¨å¹ãå‡ºã—ã®åˆæœŸåŒ–
    expressionContainer.innerHTML = '';
    if (expressionBalloon) expressionBalloon.style.display = 'none';
    if (expressionText) expressionText.textContent = '';

    // è¡¨ç¾ãƒªã‚¹ãƒˆã‚’å–å¾—
    const expressions = EXPRESSIONS[selectedLanguage]?.[selectedLevel] ?? [];

    if (expressions.length > 0) {
        expressions.forEach(expression => {
            const div = document.createElement('div');
            div.className = 'card';
            
               // è‹±èª + æ—¥æœ¬èªã®ãƒšã‚¢ã§è¡¨ç¤ºã™ã‚‹
    div.innerHTML = `
      <div class="expression-en">${expression}</div>
      <div class="expression-jp">${TRANSLATIONS[expression] || 'ï¼ˆè¨³ãªã—ï¼‰'}</div>
    `;


            // ğŸ”¥ ãƒã‚¤ãƒ©ã‚¤ãƒˆç”¨ã«IDã‚’è¿½åŠ 
            div.id = `expression-${expression.replace(/\s+/g, '-')}`;
            expressionContainer.appendChild(div);
        });

        // å¹ãå‡ºã—ã‚’è¡¨ç¤ºã—ã¦è¡¨ç¾ã‚’ãƒªã‚¹ãƒˆè¡¨ç¤º
        if (expressionBalloon && expressionText) {
            expressionBalloon.style.display = 'block';
            expressionText.textContent = `ä½¿ãˆã‚‹è¡¨ç¾\n${expressions.join('\n')}`;
        }
    }
}




// âœ… å„ãƒ¬ãƒ™ãƒ«ãƒœã‚¿ãƒ³ï¼ˆã‹ã‚“ãŸã‚“ãƒ»ãµã¤ã†ãƒ»ã‚€ãšã‹ã—ã„ï¼‰ã«ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆã‚’ä»˜ä¸
document.querySelectorAll('.level-button').forEach(button => {
  button.addEventListener('click', () => {

    // â‘  ãƒœã‚¿ãƒ³ã®ãƒã‚¤ãƒ©ã‚¤ãƒˆï¼ˆé¸æŠçŠ¶æ…‹ï¼‰ã‚’æ›´æ–°
    document.querySelectorAll('.level-button').forEach(btn => btn.classList.remove("selected"));
    button.classList.add("selected");

    // â‘¡ é¸ã°ã‚ŒãŸãƒ¬ãƒ™ãƒ«ã‚’ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã¨ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ä¿å­˜
    selectedLevel = button.dataset.level;
    localStorage.setItem('selectedLevel', selectedLevel);

    // â‘¢ è¡¨ç¾ãƒªã‚¹ãƒˆï¼ˆToioã§ä½¿ãˆã‚‹ã‚³ãƒãƒ³ãƒ‰è¡¨ï¼‰ã‚’æ›´æ–°ï¼ˆè¨€èªã¯è‹±èªå›ºå®šï¼‰
    updateExpressions("en", selectedLevel);

    // â‘£ ã‚³ãƒ¼ã‚¹ãŒã€ŒãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ã€ã®å ´åˆã¯ã€Step5ï¼ˆToioåˆ¶å¾¡ï¼‰ã¸å³ç§»å‹•
    if (selectedCourse === "navigation") {
      // ğŸ” Step5ã‹ã‚‰æˆ»ã‚‹ã¨ãã®ãŸã‚ã«ã€ç›´å‰ã®Step4ã‚’è¨˜éŒ²
      lastStep4Id = "step4-navigation";

      // â© Step5ï¼ˆå‹•ã‹ã—ã¦ã¿ã‚ˆã†ï¼‰ã«ã‚¸ãƒ£ãƒ³ãƒ—
      showStep("step5");

      console.log("ğŸš€ Step5 ã¸è‡ªå‹•é·ç§»ï¼š", selectedLevel);

    } else {
      // ãã‚Œä»¥å¤–ã®ã‚³ãƒ¼ã‚¹ï¼ˆå‰¯è©ãƒ»ç™ºéŸ³ï¼‰ã®å ´åˆã¯ã€Œæ¬¡ã¸ã€ãƒœã‚¿ãƒ³ã‚’æœ‰åŠ¹åŒ–
      const nextStepButton = document.getElementById("goToStep5");
      if (nextStepButton) {
        nextStepButton.disabled = false;
      }
    }
  });
});








// âœ… Step1: Toio æ¥ç¶š â†’ Step2
document.getElementById("connectButton").addEventListener("click", async () => {
    await connectToio();
    document.getElementById("goToStep2").disabled = false;
});

document.getElementById("goToStep2").addEventListener("click", () => {
    showStep("step2");
    console.log("â¡ï¸ Step1 â†’ Step2");
});

// âœ… Step2 â†’ Step3ï¼ˆã‚³ãƒ¼ã‚¹é¸æŠç”»é¢ï¼‰
document.getElementById("goToStep3").addEventListener("click", () => {
    showStep("step3");
    console.log("â¡ï¸ Step2 â†’ Step3ï¼ˆã‚³ãƒ¼ã‚¹é¸æŠï¼‰");
});

// âœ… Step4ï¼ˆãƒ¬ãƒ™ãƒ«é¸æŠï¼‰â†’ Step5ï¼ˆãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ã‚³ãƒ¼ã‚¹å°‚ç”¨ï¼‰
document.getElementById("goToStep5").addEventListener("click", () => {
    if (selectedCourse === "navigation") {
        lastStep4Id = "step4-navigation";
        showStep("step5");
        console.log("âœ… Step4 â†’ Step5ï¼ˆãƒŠãƒ“ã‚³ãƒ¼ã‚¹ï¼‰");
    } else {
        alert("ã“ã®ãƒœã‚¿ãƒ³ã¯ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ã‚³ãƒ¼ã‚¹å°‚ç”¨ã§ã™ï¼");
        console.warn("âš ï¸ ã“ã®ãƒœã‚¿ãƒ³ã¯ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ã‚³ãƒ¼ã‚¹å°‚ç”¨ã§ã™ï¼");
    }
});






// âœ… åˆæœŸè¨­å®šï¼ˆ"en" ã‚’æ˜ç¤ºï¼‰
const savedLevel = localStorage.getItem("selectedLevel") || "beginner";
updateExpressions("en", savedLevel); // âœ… ä¿®æ­£ãƒã‚¤ãƒ³ãƒˆ
});

//ã“ã‚Œã¾ã§OK






// ==============================
// ğŸ§­ é“æ¡ˆå†…ç”¨ï¼šNavigationå°‚ç”¨ éŸ³å£°èªè­˜è¨­å®š
// ==============================


        //ã“ã“ã‹ã‚‰éŸ³å£°èªè­˜
        // âœ… éŸ³å£°èªè­˜è¨­å®š ã“ã“ã‹ã‚‰


// âœ… Navigationç”¨ éŸ³å£°èªè­˜ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
// âœ… åˆæœŸåŒ–é–¢æ•°ï¼ˆå¿…è¦ãªã¨ãã ã‘ä½œæˆï¼‰
// âœ… Navigationç”¨ éŸ³å£°èªè­˜ã®åˆæœŸåŒ–é–¢æ•°ï¼ˆå¿…è¦ãªã¨ãã ã‘ä½œæˆï¼‰
function initRecognitionNavigation() {
  if (!window.SpeechRecognition && !window.webkitSpeechRecognition) {
    alert("ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã§ã¯éŸ³å£°èªè­˜ãŒã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚");
    console.error("âŒ SpeechRecognition æœªã‚µãƒãƒ¼ãƒˆ");
    return null;
  }

  const RecognitionClass = window.SpeechRecognition || window.webkitSpeechRecognition;
  const recognition = new RecognitionClass();

  // âœ… è¨€èªã¨è¨­å®šã®é©ç”¨
  recognition.lang = 'en-US';
  recognition.continuous = true;
  recognition.interimResults = false;
  recognition.maxAlternatives = 3;

  // âœ… éŸ³å£°èªè­˜çµæœã®å‡¦ç†
recognition.onresult = (event) => {
  const result = event.results[event.results.length - 1];
  const transcript = result[0].transcript.trim().toLowerCase();
  const confidence = result[0].confidence;

  console.log(`ğŸ¤ transcript: "${transcript}"`);
  console.log(`ğŸ§ in TRANSLATIONS?`, transcript in TRANSLATIONS);

  // === transcript ãŒç©ºï¼ˆç„¡éŸ³ãƒ»ãƒã‚¤ã‚ºï¼‰ã®å ´åˆ ===
  if (!transcript || transcript.trim().length === 0) {
    console.log("ğŸ”€ ç™ºè©±ã¯æ¤œçŸ¥ã—ãŸã‘ã©ã€å†…å®¹ãŒç©ºã ã£ãŸ");

    // ğŸ”„ ã‚¹ãƒ”ãƒŠãƒ¼ï¼‹ãƒ†ã‚­ã‚¹ãƒˆã«å¤‰æ›´ã™ã‚‹
    const spinnerHtml = `
      <span class="loader" style="display:inline-block; vertical-align: middle; margin-right: 6px;"></span>
      <span style="font-size: 14px; vertical-align: middle;">èãå–ã‚Šä¸­...</span>
    `;
    logRecognition(spinnerHtml, { autoRemoveAfter: 1500 });

    const loading = document.getElementById("loadingIndicator");
    if (loading) {
      loading.style.display = "block";
      setTimeout(() => {
        loading.style.display = "none";
      }, 1500);
    }

    return;
  }

  // === ã‚¨ã‚¤ãƒªã‚¢ã‚¹å‡¦ç†ï¼‹é¡ä¼¼ã‚³ãƒãƒ³ãƒ‰æ¢ç´¢ãƒ¬ã‚¤ãƒ¤ãƒ¼ ===
  const canonicalTranscript = ALIASES[transcript] || transcript;
  const matchedCommand = canonicalTranscript in TRANSLATIONS
    ? canonicalTranscript
    : findClosestCommand(canonicalTranscript);

  if (confidence >= 0.75 && matchedCommand) {
    if (matchedCommand === canonicalTranscript) {
      logRecognition(`âœ… ã€Œ${canonicalTranscript}ã€ã£ã¦èã“ãˆãŸã‚ˆï¼`, {
        confidence: confidence
      });
      highlightExpression(matchedCommand);
      sendtoio(matchedCommand, toio);
      flashToioGreen();
    } else {
      logRecognition(`ğŸŸ¢ ã€Œã‚‚ã—ã‹ã—ã¦ã€Œ${matchedCommand}ã€ã‹ãªï¼Ÿã€`, {
        confidence: confidence
      });
      highlightExpression(matchedCommand);
    }
  } else if (confidence >= 0.5 && matchedCommand) {
    logRecognition(`ğŸŸ¢ ã€Œ${canonicalTranscript}ã€ã‹ãªï¼Ÿ`, {
      confidence: confidence
    });
    highlightExpression(matchedCommand);
  } else if (confidence >= 0.3 && matchedCommand) {
    logRecognition(`ğŸ” ã€Œã‚ˆãèã“ãˆãªã‹ã£ãŸã¿ãŸã„ã€‚ã‚‚ã†ä¸€åº¦ãƒˆãƒ©ã‚¤ã ï¼ã€`, {
      confidence: confidence
    });
    highlightExpression(matchedCommand);
  } else {
    logRecognition(`ã€Œç™»éŒ²ã•ã‚ŒãŸãƒ•ãƒ¬ãƒ¼ã‚ºã ã‘ãŒåå¿œã™ã‚‹ã‚ˆï¼ã€`, {
      autoRemoveAfter: 2000
    });
  }
};


  // âœ… ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
  recognition.onerror = (event) => {
    console.error("ğŸš¨ NavigationéŸ³å£°èªè­˜ã‚¨ãƒ©ãƒ¼:", event.error);
  };

  console.log("ğŸ§­ Navigationèªè­˜ åˆæœŸåŒ–å®Œäº†");
  return recognition;
}



// ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚’ä¸ãˆã‚‹éš›ã«ãƒã‚¤ã‚ºã¯è¡¨ç¤ºã—ãªã„ã§ã€ç™»éŒ²ã•ã‚Œã¦ã„ã‚‹ãƒ•ãƒ¬ãƒ¼ã‚ºã«è¿‘ã„è¨€è‘‰ã ã£ãŸã‚‰ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚’è¿”ã™
function levenshtein(a, b) {
  const dp = Array.from({ length: a.length + 1 }, () => Array(b.length + 1).fill(0));
  for (let i = 0; i <= a.length; i++) dp[i][0] = i;
  for (let j = 0; j <= b.length; j++) dp[0][j] = j;

  for (let i = 1; i <= a.length; i++) {
    for (let j = 1; j <= b.length; j++) {
      if (a[i - 1] === b[j - 1]) {
        dp[i][j] = dp[i - 1][j - 1];
      } else {
        dp[i][j] = 1 + Math.min(dp[i - 1][j], dp[i][j - 1], dp[i - 1][j - 1]);
      }
    }
  }
  return dp[a.length][b.length];
}

function findClosestCommand(transcript) {
  let bestMatch = null;
  let minDistance = Infinity;

  for (const command of Object.keys(TRANSLATIONS)) {
    const distance = levenshtein(transcript, command);
    if (distance < minDistance) {
      minDistance = distance;
      bestMatch = command;
    }
  }

   if (!bestMatch) return null; // âœ… ã“ã‚ŒãŒå¤§äº‹ï¼

  const allowedDistance = Math.min(4, Math.floor(bestMatch.length * 0.4));
  // 50%ä»¥å†…ã®é•ã„ã¾ã§è¨±å®¹
  return minDistance <= allowedDistance ? bestMatch : null;
}




// âœ… éŸ³å£°èªè­˜ã®ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
recognitionNavigation.onerror = (event) => {
  if (event.error === "no-speech" || event.error === "aborted") {
    return; // ã‚ˆãã‚ã‚‹ã‚¨ãƒ©ãƒ¼ã¯ç„¡è¦–
  }

  const error = event.error;
  let friendlyMessage = `âš ï¸ ã‚¨ãƒ©ãƒ¼: ${error}`;

  if (error === "audio-capture") {
    friendlyMessage = "ğŸ™ï¸ ãƒã‚¤ã‚¯ãŒè¦‹ã¤ã‹ã‚‰ãªã‹ã£ãŸã‚ˆã†ã§ã™ã€‚ã‚‚ã†ä¸€åº¦ã¤ãªã’ã¦ã­ã€‚";
  } else if (error === "not-allowed" || error === "service-not-allowed") {
    friendlyMessage = "ğŸš« ãƒã‚¤ã‚¯ã®ä½¿ç”¨ãŒãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã¦ã„ã¾ã™ã€‚ãƒ–ãƒ©ã‚¦ã‚¶ã®è¨­å®šã‚’è¦‹ã¦ã­ã€‚";
  }

  logRecognition(friendlyMessage);
  console.error("Recognition error:", error);
};



// âœ… è¡¨ç¾ãƒã‚¤ãƒ©ã‚¤ãƒˆ
function highlightExpression(command) {
    document.querySelectorAll('.grid-container .card').forEach(item => {
        item.classList.remove('active');
    });

    const target = document.getElementById(`expression-${command.replace(/\s+/g, '-')}`);
    if (target) {
        target.classList.add('active');

        // âœ… 1.5ç§’å¾Œã« active ã‚¯ãƒ©ã‚¹ã‚’å‰Šé™¤
        setTimeout(() => {
            target.classList.remove('active');
        }, 1500);
    }
}


/* commands.jsã‚„ EXPRESSIONSã®è¨€èªã‚­ãƒ¼ã¨å¯¾å¿œã•ã›ã‚‹ãŸã‚ã®å¤‰æ›è¾æ›¸ã€‚
ç¾åœ¨ã¯å¿…è¦ãªã„ã€‚
const languageMap = {
    'en-US': 'en',
    'en-GB': 'en',
    'zh-CN': 'zh',
    'zh-TW': 'zh',
    'ko-KR': 'ko',
    'fr-FR': 'fr',
    'es-ES': 'es'
}; */

// âœ… éŸ³å£°ã‚³ãƒãƒ³ãƒ‰ã‚’ Toio ã«é€ä¿¡ï¼ˆå…¨ã‚«ãƒ†ã‚´ãƒªã‹ã‚‰æ¤œç´¢å¯¾å¿œï¼‰
async function sendtoio(command, toio) {
    console.log("ğŸ›  sendtoio å®Ÿè¡Œ: ", command);

    const selectedLanguage = 'en';

    // ğŸ” å…¨ã‚«ãƒ†ã‚´ãƒªã‹ã‚‰ã‚³ãƒãƒ³ãƒ‰ã‚’æ¢ã™
    const levels = ['beginner', 'intermediate', 'advanced', 'expressive'];
    

    for (const level of levels) {
        const cmds = window.getToioCommand(selectedLanguage, level);
        if (cmds?.[command]) {
            toioCommand = cmds[command];
            break;
        }
    }

    const handler = window.toioCommandHandlers?.[command];

    if (toioCommand instanceof Uint8Array) {
        console.log(`ğŸš€ Toioã«é€ä¿¡ã™ã‚‹ãƒã‚¤ãƒŠãƒªã‚³ãƒãƒ³ãƒ‰: ${command}`, toioCommand);
        if (toioCharacteristic) {
            try {
                await toioCharacteristic.writeValue(toioCommand);
                console.log("âœ… ãƒã‚¤ãƒŠãƒªã‚³ãƒãƒ³ãƒ‰é€ä¿¡æˆåŠŸï¼");
            } catch (error) {
                console.error(`âŒ ã‚³ãƒãƒ³ãƒ‰é€ä¿¡ã‚¨ãƒ©ãƒ¼ (${command}):`, error);
            }
        } else {
            console.warn("âš ï¸ ToioãŒæ¥ç¶šã•ã‚Œã¦ã„ã¾ã›ã‚“ï¼");
        }
    } else if (typeof handler === 'function') {
        console.log(`ğŸ”§ ã‚«ã‚¹ã‚¿ãƒ ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã‚’å®Ÿè¡Œä¸­: ${command}`);
        try {
            await handler(toio);
            console.log("âœ… ãƒãƒ³ãƒ‰ãƒ©ãƒ¼å®Ÿè¡ŒæˆåŠŸï¼");
        } catch (error) {
            console.error(`âŒ ãƒãƒ³ãƒ‰ãƒ©ãƒ¼å®Ÿè¡Œã‚¨ãƒ©ãƒ¼ (${command}):`, error);
        }
    } else {
        console.warn(`âš ï¸ '${command}' ã¯æ­£ã—ã„å½¢å¼ã®ã‚³ãƒãƒ³ãƒ‰ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚`);
    }
}


function logRecognition(message, options = {}) {
  const logBody = document.getElementById('logBody');
  if (logBody) {
    const row = document.createElement('tr');

    // === ä¿¡é ¼åº¦ãƒãƒ¼ + æ•°å€¤ ===
  const confidenceCell = document.createElement('td');
  if (options.confidence !== undefined) {
  const percentage = Math.round(options.confidence * 100);

  const wrapper = document.createElement('div');
  wrapper.className = 'confidence-wrapper';
  wrapper.style.display = 'flex'; // è¡¨ç¤ºåˆ‡æ›¿

  const container = document.createElement('div');
  container.className = 'confidence-container';

  const bar = document.createElement('div');
  bar.className = 'confidence-bar';
  bar.style.width = `${percentage}%`;

  const percentText = document.createElement('div');
  percentText.className = 'confidence-percent';
  percentText.textContent = `${percentage}%`;

  container.appendChild(bar);
  wrapper.appendChild(container);
  wrapper.appendChild(percentText);

  confidenceCell.appendChild(wrapper);
  }
  row.appendChild(confidenceCell);




    // === ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º ===
    const messageCell = document.createElement('td');
    messageCell.innerHTML = message;
    row.appendChild(messageCell);

    // === è¡¨ã«è¿½åŠ  ===
    logBody.insertBefore(row, logBody.firstChild);

    if (options.autoRemoveAfter) {
      setTimeout(() => {
        row.remove();
      }, options.autoRemoveAfter);
    }

    logBody.scrollTop = logBody.scrollHeight;
  }
}




// âœ… ãƒ­ã‚°å…¨ä½“ã‚¯ãƒªã‚¢ç”¨
function resetLog() {
  const logBody = document.getElementById('logBody');
  if (logBody) {
    logBody.innerHTML = '';
    console.log("ğŸ§¹ ãƒ­ã‚°ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸ");
  }
}

// âœ… ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°ï¼šå…¥åŠ›æ¬„ã§æ–‡å­—å…¥åŠ›ä¸­ã‹ï¼Ÿ
function isTypingInput() {
  const el = document.activeElement;
  return el && (
    el.tagName === "INPUT" ||
    el.tagName === "TEXTAREA" ||
    el.isContentEditable
  );
}

// âœ… ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰æ“ä½œå…¨èˆ¬
document.addEventListener("keydown", (event) => {
  const key = event.key;
  const visibleStep = document.querySelector('.step:not([style*="display: none"])');
  if (!visibleStep) return;

  const buttons = visibleStep.querySelectorAll('.course-button, .level-button');

  // â¬†ï¸â¬‡ï¸ ä¸Šä¸‹ã‚­ãƒ¼ã§é¸æŠç§»å‹•ï¼ˆå…¥åŠ›ä¸­ã¯ç„¡åŠ¹ï¼‰
  if ((key === "ArrowDown" || key === "ArrowUp") && buttons.length > 0 && !isTypingInput()) {
    const selected = [...buttons].find(btn => btn.classList.contains('selected'));
    let index = [...buttons].indexOf(selected);

    if (index === -1) {
      buttons[0].classList.add('selected');
      buttons[0].focus();
      return;
    }

    buttons[index].classList.remove('selected');
    index = key === "ArrowDown"
      ? (index + 1) % buttons.length
      : (index - 1 + buttons.length) % buttons.length;
    buttons[index].classList.add('selected');
    buttons[index].focus();
    return;
  }

  // â Enterã‚­ãƒ¼ï¼šé¸æŠä¸­ã‚’ã‚¯ãƒªãƒƒã‚¯ or æ¬¡ã¸
  if (key === "Enter" && !isTypingInput()) {
    const selected = visibleStep.querySelector('.selected');
    if (selected) {
      selected.click();
      return;
    }

    const nextBtn = visibleStep.querySelector('.next-button:not([disabled])');
    if (nextBtn) {
      nextBtn.click();
      return;
    }
  }

  // â¡ï¸ â†’ æ¬¡ã¸ï¼ˆå…¥åŠ›ä¸­ã¯ç„¡åŠ¹ï¼‰
  if (key === "ArrowRight" && !isTypingInput()) {
    const nextBtn = visibleStep.querySelector('.next-button:not([disabled])');
    if (nextBtn) nextBtn.click();
  }

  // â¬…ï¸ or Backspace or Esc â†’ æˆ»ã‚‹ï¼ˆå…¥åŠ›ä¸­ã¯ç„¡åŠ¹ï¼‰
  if ((key === "ArrowLeft" || key === "Backspace" || key === "Escape") && !isTypingInput()) {
    const backBtn = document.getElementById("backButton");
    if (backBtn && backBtn.style.display !== "none") {
      backBtn.click();
    }
  }

  // ğŸ”¢ æ•°å­—ã‚­ãƒ¼ 1ã€œ3 ã§é¸æŠã—ã¦ã‚¯ãƒªãƒƒã‚¯ï¼ˆå…¥åŠ›ä¸­ã¯ç„¡åŠ¹ï¼‰
  if (["1", "2", "3"].includes(key) && !isTypingInput()) {
    const index = parseInt(key) - 1;
    if (buttons[index]) {
      buttons.forEach(btn => btn.classList.remove('selected'));
      buttons[index].classList.add('selected');
      buttons[index].click();
    }
  }
});




</script>
<script src="commands.js" defer></script>
<script src="commands1js" defer></script>
<script src="commandHandlers.js"></script>
<script src="translations.js" defer></script>

</body>
</html>
